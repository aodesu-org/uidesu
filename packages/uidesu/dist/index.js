#!/usr/bin/env node
import {g,m as m$1,n,i}from'./chunk-FMM57UT3.js';import {Command}from'commander';import {promises,existsSync}from'fs';import j,{join}from'path';import y,{z as z$1}from'zod';import {cyan,green,yellow,red}from'kleur/colors';import {loadConfig,createMatchPath}from'tsconfig-paths';import {cosmiconfig}from'cosmiconfig';import f from'fs-extra';import I from'fast-glob';import Re from'ora';import {detect}from'@antfu/ni';import re from'prompts';import Ie from'os';import {execa}from'execa';var J={version:"1.0.0"};var s={error:red,warn:yellow,info:cyan,success:green};var o={error(...e){console.log(s.error(e.join(" ")));},warn(...e){console.log(s.warn(e.join(" ")));},info(...e){console.log(s.info(e.join(" ")));},success(...e){console.log(s.success(e.join(" ")));},log(...e){console.log(e.join(" "));},break(){console.log("");}};y.object({cwd:y.string(),registryFile:y.string(),outputDir:y.string()});var W=new Command().name("build").description("build components for a aodesu registry").argument("[registry]","path to registry.json file","./registry.json").option("-o, --output <path>","destination directory for json files","./public/r").option("-c, --cwd <cwd>","the working directory. defaults to the current directory.",process.cwd()).action(async(e,t)=>{try{let i=j.resolve(t.cwd),r=j.resolve(i,t.output),n=j.resolve(i,e),c=await promises.readFile(n,"utf-8"),p=g.parse(JSON.parse(c));await promises.mkdir(r,{recursive:!0});let a=p.items.map(l=>({name:l.name,type:l.type}));await promises.writeFile(j.join(r,"index.json"),JSON.stringify(a,null,2)),o.info(`\u2713 Generated ${a.length} items`),o.info(`\u2713 Output directory: ${r}`);}catch(i){i instanceof y.ZodError?(o.error("Invalid registry.json format"),i.errors.forEach(r=>{o.error(`  ${r.path.join(".")}: ${r.message}`);})):i instanceof Error?o.error(i.message):o.error("Unknown error occurred"),process.exit(1);}});var x={"next-app":{name:"next-app",label:"Next.js",links:{installation:"https://ui.uidesu.com/docs/installation/next",tailwind:"https://tailwindcss.com/docs/guides/nextjs"}},"next-pages":{name:"next-pages",label:"Next.js",links:{installation:"https://ui.uidesu.com/docs/installation/next",tailwind:"https://tailwindcss.com/docs/guides/nextjs"}},vite:{name:"vite",label:"Vite",links:{installation:"https://ui.uidesu.com/docs/installation/vite",tailwind:"https://tailwindcss.com/docs/guides/vite"}},manual:{name:"manual",label:"Manual",links:{installation:"https://ui.uidesu.com/docs/installation/manual",tailwind:"https://tailwindcss.com/docs/installation"}}};async function m(e,t){return createMatchPath(t.absoluteBaseUrl,t.paths)(e,void 0,()=>true,[".ts",".tsx",".jsx",".js",".css"])}var me=process.env.REGISTRY_URL??"https://ui.aodesu.com/r",_={"@shadcn":`${me}/styles/{style}/{name}.json`};var ge=cosmiconfig("uidesu",{searchPlaces:["uidesu.config.json"]});async function b(e){let t=await we(e);return t?await u(e,t):null}async function u(e,t){t.registries={..._,...t.registries||{}};let i=await loadConfig(e);if(console.log("aki1"),i.resultType==="failed")throw new Error(`Failed to load ${t.tsx?"tsconfig":"jsconfig"}.json. ${i.message??""}`.trim());return console.log("aki3"),n.parse({...t,resolvedPaths:{cwd:e,tailwindConfig:t.tailwind.config?j.resolve(e,t.tailwind.config):"",utils:await m(t.aliases.utils,i),components:await m(t.aliases.components,i),ui:t.aliases.ui?await m(t.aliases.ui,i):j.resolve(await m(t.aliases.components,i)??e,"ui"),lib:t.aliases.lib?await m(t.aliases.lib,i):j.resolve(await m(t.aliases.utils,i)??e,"..")}})}async function we(e){try{let t=await ge.search(e);if(!t)return null;let i=m$1.parse(t.config);if(i.registries){for(let r of Object.keys(i.registries))if(r in _)throw new Error(`"${r}" is a built-in registry and cannot be overridden.`)}return i}catch(t){let i=`${e}/uidesu.config.json`;throw t instanceof Error&&t.message.includes("reserved registry")?t:new Error(`Invalid configuration found in ${s.info(i)}.`)}}function N(e="",t=true){let i=j.join(e,"package.json");return f.readJSONSync(i,{throws:t})}var C=["**/node_modules/**",".next","public","dist","build"];z$1.object({compilerOptions:z$1.object({paths:z$1.record(z$1.string().or(z$1.array(z$1.string())))})});async function v(e){let[t,i,r,n,c,p,a,l]=await Promise.all([I.glob("**/{next,vite,astro,app}.config.*|gatsby-config.*|composer.json|react-router.config.*",{cwd:e,deep:3,ignore:C}),f.pathExists(j.resolve(e,"src")),je(e),ve(e),be(e),Y(e),ke(e),N(e,false)]),S=await f.pathExists(j.resolve(e,`${i?"src/":""}app`)),w={framework:x.manual,isSrcDir:i,isTsx:r,tailwindConfigFile:n,tailwindCssFile:c,tailwindVersion:p,frameworkVersion:null,aliasPrefix:a};return t.find(E=>E.startsWith("next.config."))?.length?(w.framework=S?x["next-app"]:x["next-pages"],w):(t.find(E=>E.startsWith("vite.config."))?.length&&(w.framework=x.vite),w)}async function Y(e){let[t,i]=await Promise.all([N(e,false),b(e)]);return i?.tailwind?.config===""?"v4":!t?.dependencies?.tailwindcss&&!t?.devDependencies?.tailwindcss?null:/^(?:\^|~)?3(?:\.\d+)*(?:-.*)?$/.test(t?.dependencies?.tailwindcss||t?.devDependencies?.tailwindcss||"")?"v3":"v4"}async function be(e){let[t,i]=await Promise.all([I.glob(["**/*.css","**/*.scss"],{cwd:e,deep:5,ignore:C}),Y(e)]);if(!t.length)return null;for(let n of t){let c=await f.readFile(j.resolve(e,n),"utf8");if(c.includes('@import "tailwindcss"')||c.includes("@import 'tailwindcss'")||c.includes("@tailwind base"))return n}return null}async function ve(e){let t=await I.glob("tailwind.config.*",{cwd:e,deep:3,ignore:C});return t.length?t[0]:null}async function ke(e){let t=await loadConfig(e);if(t?.resultType==="failed"||!Object.entries(t?.paths).length)return null;for(let[i,r]of Object.entries(t.paths))if(r.includes("./*")||r.includes("./src/*")||r.includes("./app/*")||r.includes("./resources/js/*"))return i.replace(/\/\*$/,"")??null;return Object.keys(t?.paths)?.[0].replace(/\/\*$/,"")??null}async function je(e){return (await I.glob("tsconfig.*",{cwd:e,deep:1,ignore:C})).length>0}async function K(e,t=null){let[i,r]=await Promise.all([b(e),t?Promise.resolve(t):v(e)]);if(i)return i;if(!r||!r.tailwindCssFile||r.tailwindVersion==="v3"&&!r.tailwindConfigFile)return null;let n={$schema:"https://ui.aodesu.com/schema.json",tsx:r.isTsx,style:"aodesu",tailwind:{config:r.tailwindConfigFile??"",theme:"classic",css:r.tailwindCssFile,cssVariables:true,prefix:""},aliases:{components:`${r.aliasPrefix}/components`,ui:`${r.aliasPrefix}/components/ui`,lib:`${r.aliasPrefix}/lib`,utils:`${r.aliasPrefix}/lib/utils`}};return console.log("test"),console.log(await u(e,n)),await u(e,n)}function k(e,t){return Re({text:e,isSilent:t?.silent})}async function Z(e){let t={};if(!f.existsSync(e.cwd)||!f.existsSync(j.resolve(e.cwd,"package.json")))return t["1"]=true,{errors:t,projectInfo:null};let i=k("Preflight checks.").start();f.existsSync(j.resolve(e.cwd,"uidesu.config.json"))&&(i?.fail(),o.break(),o.error(`A ${s.info("uidesu.config.json")} file already exists at ${s.info(e.cwd)}.
To start over, remove the ${s.info("uidesu.config.json")} file and run ${s.info("uidesu init")} again.`),o.break(),process.exit(1)),i?.succeed();let r=k("Verifying framework.").start(),n=await v(e.cwd);return (!n||n?.framework.name==="manual")&&(t["7"]=true,r?.fail(),o.break(),n?.framework.links.installation&&o.error(`We could not detect a supported framework at ${s.info(e.cwd)}.
Visit ${s.info(n?.framework.links.installation)} to manually configure your project.
Once configured, you can use the cli to add components.`),o.break(),process.exit(1)),r?.succeed(`Verifying framework. Found ${s.info(n.framework.label)}.`),{errors:t,projectInfo:n}}async function U(e,t={}){t={useCache:true,...t};try{return await Promise.all(e.map(async r=>{}))}catch(i){throw i}}async function q(){try{let[e]=await U(["styles/index.json"]);return i.parse(e)}catch{o.error(`
`);}}async function Q(){try{let[e]=await U(["themes/index.json"]);return i.parse(e)}catch{o.error(`
`);}}async function X(e,{withFallback:t}={withFallback:false}){let i=await detect({programmatic:true,cwd:e});if(i==="yarn@berry")return "yarn";if(i==="pnpm@6")return "pnpm";if(i==="bun")return "bun";if(i==="deno")return "deno";if(!t)return i??"npm";let r=process.env.npm_config_user_agent||"";return r.startsWith("yarn")?"yarn":r.startsWith("pnpm")?"pnpm":r.startsWith("bun")?"bun":"npm"}var Ce="https://codeload.github.com/shadcn-ui/ui/tar.gz/main";async function z(e,t){let i=k("Creating a new Vite project. This may take a few minutes.").start();try{let r=j.join(Ie.tmpdir(),`shadcn-template-${Date.now()}`);await f.ensureDir(r);let n=await fetch(Ce);if(!n.ok)throw new Error(`Failed to download template: ${n.statusText}`);let c=j.resolve(r,"template.tar.gz");await f.writeFile(c,Buffer.from(await n.arrayBuffer())),await execa("tar",["-xzf",c,"-C",r,"--strip-components=2","ui-main/templates/vite-app"]);let p=j.resolve(r,"vite-app");if(await f.move(p,e),await f.remove(r),t.packageManager!=="pnpm"){let l=j.join(e,"pnpm-lock.yaml");f.existsSync(l)&&await f.remove(l);}await execa(t.packageManager,["install"],{cwd:e});let a=j.join(e,"package.json");if(f.existsSync(a)){let l=await f.readFile(a,"utf8"),S=JSON.parse(l);S.name=e.split("/").pop(),await f.writeFile(a,JSON.stringify(S,null,2));}await execa("git",["--version"],{cwd:e}),await execa("git",["init"],{cwd:e}),await execa("git",["add","-A"],{cwd:e}),await execa("git",["commit","-m","Initial commit"],{cwd:e}),i?.succeed("Creating a new Vite project.");}catch{i?.fail("Something went wrong creating a new Vite project.");}}async function ee(e){e={srcDir:false,...e};let t="vite",i="my-app",{type:r,name:n}=await re([{type:"select",name:"type",message:`The path ${s.info(e.cwd)} does not contain a package.json file.
   Would you like to start a new vite project?`,choices:[{title:"Yes, create a new vite project",value:"vite"},{title:"No, exit and create a project manually",value:"exit"}],initial:0},{type:e.name?null:"text",name:"name",message:"What is your project named?",initial:i,format:a=>a.trim(),validate:a=>a.length>128?"Name should be less than 128 characters.":true}]);t=r??t,i=n??i;let c=await X(e.cwd,{withFallback:true}),p=`${e.cwd}/${i}`;try{await f.access(e.cwd,f.constants.W_OK);}catch{o.break(),o.error(`The path ${s.info(e.cwd)} is not writable.`),o.error(`It is likely you don't have permissions for this folder or the paths ${s.info(e.cwd)} does not exist.`),o.break(),process.exit(1);}return f.existsSync(j.resolve(e.cwd,i,"package.json"))&&(o.break(),o.error(`A project with the name ${s.info(i)} already exists.`),o.error("Please choose a different name and try again."),o.break(),process.exit(1)),await z(p,{packageManager:c}),{projectPath:p,projectName:i,template:t}}async function te(e=process.cwd()){try{let{config:t}=await import('@dotenvx/dotenvx'),i=[".env.local",".env.development.local",".env.development",".env"];for(let r of i){let n=join(e,r);existsSync(n)&&t({path:n,overload:!1,quiet:!0});}}catch(t){o.warn("Failed to load env files:",t);}}process.on("exit",e=>{let t=j.resolve(process.cwd(),"uidesu.config.json");e===0&&o.info("\u2713 uidesu initialized successfully!"),o.info(`Configuration file created at:
${t}`);});var Ne=z$1.object({cwd:z$1.string(),name:z$1.string().optional(),yes:z$1.boolean(),srcDir:z$1.boolean().optional()}),oe=new Command().name("init").description("initialize a uidesu in your project.").option("-y, --yes","skip prompts and use default values",false).option("-c, --cwd <cwd>","the working directory. defaults to the current directory.",process.cwd()).option("--src-dir","use the src directory when creating a new project.",false).action(async e=>{try{let t=Ne.parse({cwd:j.resolve(e.cwd),...e});await te(t.cwd),await $e(t),o.success(`Initialized uidesu in directory: ${e.cwd}`),o.break();}catch{o.break();}});async function $e(e){let t,r=await Z(e);if(r.errors["1"]){let{projectPath:a,template:l}=await ee(e);a||process.exit(1),e.cwd=a,t=await v(e.cwd);}else t=r.projectInfo;let n=await K(e.cwd,t);console.log(n);let c=n?await De(n):await Me(await b(e.cwd));if(!e.yes){let{proceed:a}=await re({type:"confirm",name:"proceed",message:`Write configuration to ${s.info("uidesu.config.json")}. Proceed?`,initial:true});a||process.exit(0);}await u(e.cwd,c);}async function Me(e=null){let[t,i]=await Promise.all([q(),Q()]);o.info("");let r=await re([{type:"toggle",name:"typescript",message:`Would you like to use ${s.info("TypeScript")} (recommended)?`,initial:e?.tsx??true,active:"yes",inactive:"no"}]);return m$1.parse({$schema:"https://ui.aodesu.com/schema.json",tsx:r.typescript})}async function De(e,t){let i=e.style,r=e.tailwind.theme,n=e.tailwind.cssVariables;return m$1.parse({$schema:e?.$schema,style:i,tailwind:{...e?.tailwind,theme:r,cssVariables:n},tsx:e?.tsx,aliases:e?.aliases})}process.on("SIGNINT",()=>process.exit(0));process.on("SIGTERM",()=>process.exit(0));async function Ue(){let e=new Command().name("uidesu").description("add items from registry to your project").version(J.version,"-v, --version","display the version number");e.addCommand(oe).addCommand(W),e.parse();}Ue();//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map